# Supabase 초기화 및 데이터 마이그레이션 가이드

이 가이드는 Supabase 프로젝트를 새로 만들고, 기존 데이터를 안전하게 옮기는 방법을 단계별로 설명합니다.
SQL 파일을 별도로 찾을 필요 없이, 아래 코드를 복사해서 바로 실행하실 수 있도록 구성했습니다.

---

## 1. 새 Supabase 프로젝트 생성

1.  [Supabase Dashboard](https://supabase.com/dashboard)에 접속합니다.
2.  **New Project**를 클릭하여 새 프로젝트를 생성합니다.
3.  Name, Database Password, Region(Seoul)을 설정하고 **Create new project**를 누릅니다.
4.  프로젝트 생성이 완료될 때까지 기다립니다.

---

## 2. 환경 변수 연결 (.env.local 수정)

새 프로젝트의 API 키를 로컬 환경에 연결합니다.

1.  Supabase 대시보드 > **Project Settings (톱니바퀴)** > **API** 메뉴로 이동합니다.
2.  VS Code에서 `.env.local` 파일을 열고 값을 수정합니다.

```env
# .env.local 예시
NEXT_PUBLIC_SUPABASE_URL=https://새로운프로젝트ID.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=새로운_ANON_KEY
```

---

## 3. 데이터베이스 테이블 생성 (Schema)

새 데이터베이스에 테이블을 생성합니다.

1.  Supabase 대시보드 좌측 **SQL Editor**로 이동합니다.
2.  **New Query**를 누르고 아래 SQL을 복사해 붙여넣은 뒤 **Run**을 클릭합니다.

```sql
-- Enable necessary extensions
create extension if not exists "uuid-ossp";

-- Drop existing tables if they exist (to ensure clean slate if re-run)
drop table if exists products cascade;
drop table if exists sub_categories cascade;
drop table if exists categories cascade;

-- 1. Categories Table
create table categories (
  id bigint generated by default as identity primary key,
  name text not null unique,
  "order" int default 0,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 2. Sub Categories Table
create table sub_categories (
  id bigint generated by default as identity primary key,
  category_id bigint references categories(id) on delete cascade not null,
  name text not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  unique(category_id, name)
);

-- 3. Products Table
create table products (
  id uuid default uuid_generate_v4() primary key,
  sub_id bigint references sub_categories(id) on delete cascade not null,
  name text not null,
  img_urls text[] default '{}',
  external_url text,
  description text,
  specs jsonb default '{}'::jsonb,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Enable Row Level Security (RLS)
alter table categories enable row level security;
alter table sub_categories enable row level security;
alter table products enable row level security;

-- Create Policies (Public Read Access)
create policy "Allow public read access on categories"
  on categories for select
  using (true);

create policy "Allow public read access on sub_categories"
  on sub_categories for select
  using (true);

create policy "Allow public read access on products"
  on products for select
  using (true);

-- 4. Profiles Table (For Admin Permission)
create table profiles (
  id uuid references auth.users on delete cascade primary key,
  role text default 'user' check (role in ('user', 'admin')),
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

alter table profiles enable row level security;

create policy "Public profiles are viewable by everyone"
  on profiles for select
  using (true);

create policy "Users can insert their own profile"
  on profiles for insert
  with check ( auth.uid() = id );

create policy "Admins can update profiles"
  on profiles for update
  using (
    exists (
      select 1 from profiles
      where profiles.id = auth.uid() and profiles.role = 'admin'
    )
  );

-- Grant Admin Write Access to Products/Categories
create policy "Allow admin full access on categories"
  on categories for all
  using ( exists ( select 1 from profiles where profiles.id = auth.uid() and profiles.role = 'admin' ) );

create policy "Allow admin full access on sub_categories"
  on sub_categories for all
  using ( exists ( select 1 from profiles where profiles.id = auth.uid() and profiles.role = 'admin' ) );

create policy "Allow admin full access on products"
  on products for all
  using ( exists ( select 1 from profiles where profiles.id = auth.uid() and profiles.role = 'admin' ) );
```

---

## 4. 회원가입 트리거 설정 (Trigger)

회원가입 시 자동으로 프로필을 생성하여 로그인 오류(`406 error`)를 방지하는 필수 설정입니다.
위와 마찬가지로 SQL Editor에서 실행(`Run`)하세요.

```sql
-- 1. 새로운 유저가 가입할 때 자동으로 public.profiles에 행을 생성하는 함수
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.profiles (id, role)
  VALUES (new.id, 'user');
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 2. auth.users 테이블에 트리거 부착
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();

-- 3. 기존 유저 데이터 백필 (혹시 이미 가입한 유저가 있다면)
INSERT INTO public.profiles (id, role)
SELECT id, 'user'
FROM auth.users
WHERE id NOT IN (SELECT id FROM public.profiles)
ON CONFLICT (id) DO NOTHING;
```

---

## 5. 엑셀 데이터 가져오기 (Import)

이제 텅 빈 DB에 엑셀 데이터를 넣습니다.

1.  **터미널**을 열고 필요한 라이브러리를 설치합니다.
    ```bash
    npm install xlsx dotenv
    ```
2.  데이터 가져오기 스크립트를 실행합니다. (이 스크립트는 `scripts/import_excel.ts`에 있습니다)
    ```bash
    npx ts-node scripts/import_excel.ts
    ```
    *   성공 시: "Import completed" 메시지가 뜹니다.

---

## 6. 관리자 계정 생성 및 권한 부여

마지막으로 관리자 계정을 만듭니다.

1.  **Supabase Dashboard** > **Authentication** > **Users**에서 `Add User`로 계정을 만듭니다. (예: `eterna@gmail.com`)
2.  SQL Editor에서 아래 쿼리의 이메일을 수정하여 실행합니다.

```sql
-- 'eterna@gmail.com'을 실제 가입한 이메일로 변경하세요!
UPDATE public.profiles
SET role = 'admin'
WHERE id IN (
  SELECT id FROM auth.users WHERE email = 'eterna@gmail.com'
);
```

3.  이제 웹사이트에서 해당 계정으로 **관리자 로그인**을 시도합니다.

---
**완료되었습니다!** 이제 깔끔한 상태에서 다시 시작하실 수 있습니다.
